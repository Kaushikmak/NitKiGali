<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Channels Chat</title>
    <!-- 1. Include Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple scrollbar for chat log */
        #chat-log::-webkit-scrollbar { width: 4px; }
        #chat-log::-webkit-scrollbar-track { background: #f1f1f1; }
        #chat-log::-webkit-scrollbar-thumb { background: #888; border-radius: 2px; }
        #chat-log::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto max-w-lg mt-10 p-6 bg-white rounded-lg shadow-xl">

        <!-- 
          STATE 1: Start Button
        -->
        <div id="start-container" class="text-center">
            <h1 class="text-2xl font-semibold mb-4">Chat Roulette</h1>
            <p class="text-gray-600 mb-6">Click the button to find a random chat partner.</p>
            <button id="find-chat-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                Find Chat
            </button>
        </div>

        <!-- 
          STATE 2: Waiting Status
        -->
        <div id="status-container" class="text-center hidden">
            <h2 class="text-xl font-semibold text-gray-700">Connecting...</h2>
            <!-- Simple spinner -->
            <div class="flex justify-center items-center my-6">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            </div>
            <p id="status-message" class="text-gray-600">Waiting for a partner...</p>
            
            <!-- NEW: Quit button for waiting -->
            <button id="quit-waiting-button" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Quit
            </button>
        </div>
        
        <!-- 
          STATE 3: Chat Room
        -->
        <div id="chat-container" class="hidden">
            <!-- NEW: Header with Skip/Quit buttons -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-semibold">Chat Room</h1>
                <div class="space-x-2">
                    <button id="skip-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Skip
                    </button>
                    <button id="quit-chat-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Quit
                    </button>
                </div>
            </div>
            
            <!-- Message Display Area -->
            <div id="chat-log" class="h-80 overflow-y-auto bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                <!-- Messages will be appended here -->
            </div>
            
            <!-- Message Input Area -->
            <div class="flex space-x-2">
                <input id="chat-message-input" type="text" placeholder="Type a message..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="chat-message-submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    Send
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // --- Get DOM Elements ---
        const startContainer = document.getElementById('start-container');
        const findChatButton = document.getElementById('find-chat-button');
        
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const quitWaitingButton = document.getElementById('quit-waiting-button');

        const chatContainer = document.getElementById('chat-container');
        const chatLog = document.getElementById('chat-log');
        const chatMessageInput = document.getElementById('chat-message-input');
        const chatMessageSubmit = document.getElementById('chat-message-submit');
        const skipButton = document.getElementById('skip-button');
        const quitChatButton = document.getElementById('quit-chat-button');

        // Store the active WebSocket connection
        let matchmakingSocket = null;
        let chatSocket = null;
        
        // --- WebSocket Host ---
        const wsHost = 'ws://localhost:8000';

        // --- Utility to log messages to the chat box ---
        function logMessage(message, source = 'system') {
            const p = document.createElement('p');
            
            if (source === 'user') {
                p.className = 'text-right text-blue-600 mb-1';
                p.textContent = `You: ${message}`;
            } else if (source === 'partner') {
                p.className = 'text-left text-gray-700 mb-1';
                p.textContent = `Partner: ${message}`;
            } else {
                p.className = 'text-center text-sm text-gray-500 italic my-2';
                p.textContent = message;
            }
            
            chatLog.appendChild(p);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // --- Resets the UI to the initial state ---
        function resetToStartScreen() {
            // Hide other containers
            statusContainer.classList.add('hidden');
            chatContainer.classList.add('hidden');
            
            // Show start container
            startContainer.classList.remove('hidden');

            // Clear chat log
            chatLog.innerHTML = '';
            
            // Reset message input
            chatMessageInput.value = '';
            chatMessageInput.disabled = false;
            chatMessageInput.placeholder = 'Type a message...';
            chatMessageSubmit.disabled = false;

            // Reset status message
            statusMessage.textContent = 'Waiting for a partner...';
            statusMessage.classList.remove('text-red-500');
        }

        // --- Closes all active sockets ---
        function closeAllSockets() {
            if (matchmakingSocket) {
                matchmakingSocket.onclose = null; // Prevent old handlers from firing
                matchmakingSocket.close();
                matchmakingSocket = null;
            }
            if (chatSocket) {
                chatSocket.onclose = null; // Prevent old handlers from firing
                chatSocket.close();
                chatSocket = null;
            }
        }

        // --- 1. Connect to Matchmaker ---
        function startMatchmaking() {
            // Show the "waiting" UI
            startContainer.classList.add('hidden');
            chatContainer.classList.add('hidden');
            statusContainer.classList.remove('hidden');
            
            // Clean up any old sockets
            closeAllSockets();

            // Create the matchmaking socket
            matchmakingSocket = new WebSocket(wsHost + '/ws/find_chat/');

            matchmakingSocket.onopen = function(e) {
                console.log('Matchmaking WebSocket connected.');
            };

            matchmakingSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                if (data.status === 'waiting') {
                    console.log('Waiting for partner...');
                    statusMessage.textContent = 'Waiting for a partner...';
                }
                
                if (data.type === 'redirect') {
                    const roomName = data.room_name;
                    console.log('Match found! Redirecting to room: ' + roomName);

                    // Close this socket
                    if(matchmakingSocket) {
                        matchmakingSocket.close();
                        matchmakingSocket = null; // Clear it
                    }
                    
                    // Connect to the new chat room
                    connectToChatRoom(roomName);
                }
            };

            matchmakingSocket.onclose = function(e) {
                console.log('Matchmaking socket closed.');
            };

            matchmakingSocket.onerror = function(e) {
                console.error('Matchmaking socket error:', e);
                statusMessage.textContent = 'Error connecting. Please refresh.';
                statusMessage.classList.add('text-red-500');
            };
        }

        // --- 2. Connect to Chat Room ---
        function connectToChatRoom(roomName) {
            // Show the chat UI
            statusContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');

            // --- BUG FIX ---
            // Reset UI for the new chat room
            chatLog.innerHTML = ''; // Clear the log
            chatMessageInput.value = ''; // Clear old text
            chatMessageInput.disabled = false; // Re-enable input
            chatMessageSubmit.disabled = false; // Re-enable send button
            chatMessageInput.placeholder = 'Type a message...';
            // --- END FIX ---

            chatSocket = new WebSocket(
                wsHost + '/ws/chat/' + roomName + '/'
            );

            chatSocket.onopen = function(e) {
                console.log('Chat WebSocket connected.');
                logMessage('You are connected.', 'system');
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Chat message received:', data.message);
                
                // Don't show our own "joined" message
                if (data.message === '[Partner has joined the chat]' && chatLog.childElementCount > 1) {
                    logMessage(data.message, 'system');
                } else if (data.message !== '[Partner has joined the chat]') {
                    logMessage(data.message, 'partner');
                }
            };

            chatSocket.onclose = function(e) {
                console.log('Chat socket closed.');
                
                // Check if this onclose is for the *current* socket
                // If chatSocket is null, it means we already closed it (e.g., via Skip)
                // and this is a late event from an old socket.
                if (chatSocket === null) {
                    console.log('Stale onclose event ignored.');
                    return;
                }

                logMessage('Connection closed.', 'system');
                chatMessageSubmit.disabled = true;
                chatMessageInput.disabled = true;
                chatMessageInput.placeholder = 'Disconnected';
            };

            chatSocket.onerror = function(e) {
                console.error('Chat socket error:', e);
                logMessage('Connection error.', 'system');
            };
        }
        
        // --- 3. Send a Chat Message ---
        function sendChatMessage() {
            const message = chatMessageInput.value;
            if (message.trim() === '') return;

            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                logMessage(message, 'user');
                chatMessageInput.value = '';
            }
        }

        // --- EVENT LISTENERS ---

        // Start button
        findChatButton.onclick = startMatchmaking;

        // Send button
        chatMessageSubmit.onclick = sendChatMessage;

        // Send on "Enter" key
        chatMessageInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Skip button (in chat)
        skipButton.onclick = function() {
            logMessage('You skipped the chat.', 'system');
            console.log('Skip button clicked. Finding new chat.');
            // Go back to waiting pool
            startMatchmaking(); 
        };

        // Quit button (in chat)
        quitChatButton.onclick = function() {
            console.log('Quit button clicked. Closing sockets.');
            closeAllSockets();
            resetToStartScreen();
        };

        // Quit button (while waiting)
        quitWaitingButton.onclick = function() {
            console.log('Quit (waiting) button clicked. Closing sockets.');
            closeAllSockets();
            resetToStartScreen();
        };

    </script>
</body>
</html>

